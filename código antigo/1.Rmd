---
title: "Projeto"
author: "Christian Neitzel, Diana Silva, Tiago Miranda"
date: "r format(Sys.time(), '%Y-%m-%d')"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objetivo do trabalho:

Este trabalho cont√©m uma an√°lise demonstrativa de express√£o gen√©tica diferencial, utilizando amostras de sequenciamento direcionado de 526 tumores de bexiga e seus normais correspondentes atrav√©s do MSK-IMPACT. O conjunto de dados selecionado inclui 526 amostras de mais de 400 pacientes, nas quais a express√£o gen√©tica foi quantificada.

Conjunto de Dados selecionados:
https://portal.gdc.cancer.gov/projects/TCGA-ACC 
https://www.ncbi.nlm.nih.gov/projects/gap/cgi-bin/study.cgi?study_id=phs000178.v11.p8&phv=354519&phd=&pha=&pht=7516&phvf=&phdf=&phaf=&phtf=&dssp=1&consent=&temp=1

Em primeiro lugar, procedemos √† instala√ß√£o dos packages necess√°rios para realizar a an√°lise da express√£o diferencial.


```{r}
# Instala√ß√£o e carregamento dos pacotes necess√°rios
# Verifica se o BiocManager est√° instalado e instala se necess√°rio
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

# Verifica se o pacote cBioPortalData est√° instalado e instala se necess√°rio
if (!requireNamespace("cBioPortalData", quietly = TRUE))
  BiocManager::install("cBioPortalData")

BiocManager::install(c("edgeR", "limma", "Glimma", "gplots", "org.Mm.eg.db", "RColorBrewer", "TCGAbiolinks", "DESeq2"), ask = FALSE)

# Instala√ß√£o dos pacotes "GGally" e "tibble"
if (!requireNamespace("GGally", quietly = TRUE))
  install.packages("GGally", dependencies = TRUE, repos = "https://CRAN.R-project.org/")

if (!requireNamespace("tibble", quietly = TRUE)) {
  install.packages("tibble")
}

# Carrega os pacotes instalados/necess√°rios
library(edgeR)
library(limma)
library(tidyverse)
library(ggplot2)
library(GGally)
library(tibble)
library(dplyr)
library(DESeq2)

# Carregamento do pacote cBioPortalData
library(cBioPortalData)

# Inicializa√ß√£o da API do cBioPortal
cbio <- cBioPortal()
```
# Explora√ß√£o dos dados presentes no data set
## Including Plots

Nesta fase √© realizado o carregamento dos dados clinicos do estudo,  explorados os ensaios do estudo disponiveis e organizados em dataframes:

```{r pressure, echo=FALSE}
# Obter dados cl√≠nicos
bladder_clin <- clinicalData(api = cbio, studyId = "bladder_msk_2023")
bladder_clin
dim(bladder_clin)  # Deve retornar 526 linhas e 29 colunas

# Carrega os dados do cBioPortal
bladder = cBioDataPack("bladder_msk_2023", ask = FALSE)
bladder

# Lista os nomes dos ensaios dispon√≠veis no pacote dos dados do CBioPortal
names(assays(bladder))
# names(rowData(bladder)) # tipos de metadados associados a cada gene
# names(colData(bladder)) # tipos de metadados associados a cada amostra

# Summary dos dados
summary(bladder)

# Consulta dos dados de cna e conver√ß√£o em dataframe.
dados_cna = assays(bladder)$cna
dados_cna_df = as.data.frame(dados_cna)

# Consulta dos dados de cna_hg19 e conver√ß√£o em dataframe.
dados_cna_hg19 = assays(bladder)$cna_hg19.seg
dados_cna_hg19_df = as.data.frame(dados_cna_hg19)

# Consulta dos dados de muta√ß√£o e conver√ß√£o em dataframe
dados_mutacao = assays(bladder)$mutations
dados_mutacao_df = as.data.frame(dados_mutacao)
```
```{r}
# Extra√ß√£o dos Metadados
# Aceder aos ficheiros dos metadados (formato .txt) presentes na pasta "bladder_msk_2023"
setwd("bladder_msk_2023")
meta_cna_hg19_seg <- read.delim("meta_cna_hg19_seg.txt", sep = ":", 
                                header = FALSE, 
                                row.names = 1, 
                                col.names = c("", "data")
                                )
meta_cna_hg19_seg

meta_cna <- read.delim("meta_cna.txt", sep = ":", 
                       header = FALSE, 
                       row.names = 1, 
                       col.names = c("", "data")
)
meta_cna

# Metadados do estudo
meta_study <- read.delim("meta_study.txt", sep = ":", 
                         header = FALSE, 
                         row.names = 1, 
                         col.names = c("", "data")
                         )
meta_study["citation", "data"] # Cita√ß√£o
meta_study["pmid", "data"]     # pmid (PubMed ID), permite encontrar o artigo da qual originaram os dados

```
```{r}
# Alterar/corrigir nome de colunas
colnames(bladder_clin)[colnames(bladder_clin) == "SMOKIMG_STATUS"] <- "SMOKING_STATUS"
colnames(bladder_clin)[colnames(bladder_clin) == "patientId"] <- "PATIENT_ID"

# Verificar colunas com valores NA
colSums(is.na(bladder_clin)) # Verifica quandos valores NA cada coluna tem
print(colSums(is.na(bladder_clin))[colSums(is.na(bladder_clin)) > 0]) # Mostra quais as colunas t√™m valores NA
```
## Determina√ß√£o das vari√°veis para a An√°lise Estat√≠stica

```{r}
str(bladder_clin) # Verifica-se aqui que todas as colunas s√£o do tipo chr (character)

# Convers√£o de colunas que possuem valores num√©ricas (no entanto n√£o s√£o) para serem num√©ricas
bladder_clin <- bladder_clin %>%
  mutate(
    SEQUENCING_OS_MONTHS = as.numeric(SEQUENCING_OS_MONTHS),
    AGE_AT_SEQ_REPORTED_YEARS = as.numeric(AGE_AT_SEQ_REPORTED_YEARS),
    FRACTION_GENOME_ALTERED = as.numeric(FRACTION_GENOME_ALTERED),
    MSI_SCORE = as.numeric(MSI_SCORE),
    MUTATION_COUNT = as.numeric(MUTATION_COUNT),
    SAMPLE_COVERAGE = as.numeric(SAMPLE_COVERAGE),
    TMB_NONSYNONYMOUS = as.numeric(TMB_NONSYNONYMOUS),
    TUMOR_PURITY = as.numeric(TUMOR_PURITY),
    BEST_RESPONSE = as.numeric(BEST_RESPONSE)
  )

# Subconjunto do conjunto de dados para apenas incluir as colunas num√©ricas
numeric_data <- bladder_clin[, sapply(bladder_clin, is.numeric)]

# Cria√ß√£o de um pairplot com s√≥ as colunas num√©ricas para verificar as correla√ß√µes
pairplot <- GGally::ggpairs(numeric_data, cardinality_threshold = Inf)
pairplot

ggsave("pairplot.png", pairplot) # Guarda o pairplot como uma imagem .png no working directory

# Analisando o pairplot, podemos deduzir que as colunas que precisam de ser logaritmizadas s√£o: 
# MSI_SCORE
# MUTATION_COUNT
# SAMPLE_COVERAGE
# TMB_NONSYNONYMOUS

```
## Tratamento dos NAs
```{r}
# Tratamento dos NAs
cleaned_data <- na.omit(bladder_clin) # Cria√ß√£o de um novo dataset que exclui todas as amostras com valores NA (96% dos dados)
cleaned_data

# Itera sobre cada coluna procura por valores NA, verifica se √© coluna num√©rica e calcula a mediana, seguido de substitui√ß√£o dos NAs com a mediana dessa coluna. Se a coluna n√£o for num√©rica, substitui os NAs por "Unknown"
for (col in names(bladder_clin)) {
  if (anyNA(bladder_clin[[col]])) {
    if (is.numeric(bladder_clin[[col]])) {
      median_val <- median(bladder_clin[[col]], na.rm = TRUE)
      bladder_clin[[col]][is.na(bladder_clin[[col]])] <- median_val
    } else {
      # Substitui valores NA nas colunas "character type" por "Unknown"
      bladder_clin[[col]][is.na(bladder_clin[[col]])] <- "Unknown"
    }
  }
}

bladder_clin
```

Normaliza√ß√£o dos dados
```{r}
# Normaliza√ß√£o dos dados
# Definida uma fun√ß√£o "function(x) para Min-Max Scaling
min_max_scaling <- function(x) {
  if(is.numeric(x)) {
    return ((x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE)))
  } else {
    return (x)
  }
}

# Min-Max Scaling √© aplicada exclusivamente a colunas num√©ricas
normalized_numeric <- lapply(bladder_clin, min_max_scaling)
normalized_bladder_clin <- bladder_clin # Dataset com os dados normalizados

# Substitui√ß√£o dos valores das colunas num√©ricas com os seus valores normalizados
for (col in names(bladder_clin)) {
  if (is.numeric(bladder_clin[[col]])) {
    normalized_bladder_clin[[col]] <- normalized_numeric[[col]]
  }
}

```
## Defini√ß√£o das vari√°veis com as.factor
```{r}
# Idade em que a Sequencia√ß√£o foi Reportada (Anos)
age = as.factor(bladder_clin$AGE_AT_SEQ_REPORTED_YEARS)

# Tipo de Cancro
cancer_type = as.factor(bladder_clin$CANCER_TYPE_DETAILED)

# Estado da Doen√ßa
disease_state = as.factor(bladder_clin$DISEASE_STATE)

# Tratamento com Erdafitinib
erdafitinib_treatment = as.factor(bladder_clin$ERDAFITINIB_TREATED)

# Estado de Sobreviv√™ncia Global desde o Tx com Erdafitinib
overall_status = as.factor(bladder_clin$ERDAFITINIB_TX_OS_STATUS)

# Estado Sem Progress√£o desde o Tx com Erdafitinib
progression_status = as.factor(bladder_clin$ERDAFITINIB_TX_PFS_STATUS)

# Painel de Genes
gene_panel = as.factor(bladder_clin$GENE_PANEL)

# Tipo MSI
msi_type = as.factor(bladder_clin$MSI_TYPE)

# C√≥digo Oncotree
oncotree_code = as.factor(bladder_clin$ONCOTREE_CODE)

# Ra√ßa
race = as.factor(bladder_clin$RACE)

# Classe da Amostra
sample_class = as.factor(bladder_clin$SAMPLE_CLASS)

# Sexo
sexo = as.factor(bladder_clin$SEX)

# Estado de Fumador
smoking_status = as.factor(bladder_clin$SMOKING_STATUS)

# Estado Som√°tico
somatic_status = as.factor(bladder_clin$SOMATIC_STATUS)

```
####An√°lise estat√≠stica univariada e Caracteriza√ß√£o dos tipos de variaveis
### 1 Vari√°veis Num√©ricas

1.1. Idade em que a Sequencia√ß√£o foi Reportada (Anos)
1.2. Sobreviv√™ncia Global (Meses desde o Tx com Erdafitinib)
1.3. Sobreviv√™ncia Sem Progress√£o (Meses desde o Tx com Erdafitinib)
1.4. Sobreviv√™ncia Global em Meses desde o Sequenciamento

Na an√°lise dessas vari√°veis num√©ricas, come√ßamos por:

1. Remover valores ausentes e calcular estat√≠sticas descritivas:
    - Primeiro, os valores ausentes (NaNs) da coluna com vari√°veis num√©ricas s√£o removidos do conjunto de dados.
    - Em seguida, s√£o calculadas algumas estat√≠sticas descritivas:
        - M√©dia dos valores da vari√°vel: Calcula-se a m√©dia dos valores da vari√°vel presentes no conjunto de dados limpo.
        - Mediana dos valores da vari√°vel: Determina-se a mediana dos valores da vari√°vel.
        - Desvio padr√£o dos valores da vari√°vel: Calcula-se o desvio padr√£o dos valores da vari√°vel.
        - Intervalo interquart√≠lico (IQR): O IQR √© a diferen√ßa entre o terceiro quartil (Q3) e o primeiro quartil (Q1) dos valores da vari√°vel.

2. Barplot e boxplot:
    - Um gr√°fico de barras (barplot) √© criado para visualizar a distribui√ß√£o dos valores da vari√°vel.
    - Um gr√°fico de caixa (boxplot) √© gerado para mostrar a varia√ß√£o e os poss√≠veis valores at√≠picos dos valores da vari√°vel.


####1.1. Idade em que a Sequencia√ß√£o foi Reportada (Anos)
```{r}
# Remover valores ausentes e calcular estat√≠sticas descritivas
summary(na.omit(bladder_clin$AGE_AT_SEQ_REPORTED_YEARS))

# Desvio padr√£o
sd(na.omit(bladder_clin$AGE_AT_SEQ_REPORTED_YEARS))

# Intervalo Interquart√≠lico
IQR(na.omit(bladder_clin$AGE_AT_SEQ_REPORTED_YEARS))

# Barplot e boxplot
barplot(table(bladder_clin$AGE_AT_SEQ_REPORTED_YEARS))
boxplot(as.numeric(bladder_clin$AGE_AT_SEQ_REPORTED_YEARS),
        main = "Idade em que a Sequ√™ncia foi Reportada (Anos)",
        xlab = "Idade", horizontal = TRUE)

```
####1.2. Sobreviv√™ncia Global (Meses desde o Tx com Erdafitinib)
```{r}
# Remover valores ausentes e calcular estat√≠sticas descritivas
summary(na.omit(bladder_clin$ERDAFITINIB_TX_OS_MONTHS))

# Desvio padr√£o
sd(na.omit(bladder_clin$ERDAFITINIB_TX_OS_MONTHS))

# Intervalo Interquart√≠lico
IQR(na.omit(bladder_clin$ERDAFITINIB_TX_OS_MONTHS), na.rm = TRUE)

# Barplot e boxplot
barplot(table(bladder_clin$ERDAFITINIB_TX_OS_MONTHS))
boxplot(as.numeric(bladder_clin$ERDAFITINIB_TX_OS_MONTHS),
        main = "Sobreviv√™ncia Global (Meses desde o Tx com Erdafitinib)",
        xlab = "Meses", horizontal = TRUE)


```
####1.3. Sobreviv√™ncia Sem Progress√£o (Meses desde o Tx com Erdafitinib)
```{r}
# Remover valores ausentes e calcular estat√≠sticas descritivas
summary(na.omit(bladder_clin$ERDAFITINIB_TX_PFS_MONTHS))

# Desvio padr√£o
sd(na.omit(bladder_clin$ERDAFITINIB_TX_PFS_MONTHS))

# Intervalo Interquart√≠lico
IQR(na.omit(bladder_clin$ERDAFITINIB_TX_PFS_MONTHS), na.rm = TRUE)

# Barplot e boxplot
barplot(table(bladder_clin$ERDAFITINIB_TX_PFS_MONTHS))
boxplot(as.numeric(bladder_clin$ERDAFITINIB_TX_PFS_MONTHS), horizontal = T)

```
### 2. Vari√°veis Categ√≥ricas:

2.1. Detalhes do Tipo de C√¢ncro
2.2. Estado da Doen√ßa
2.3. Tratamento com Erdafitinibe
2.4. Status de Sobreviv√™ncia Global desde o Tratamento com Erdafitinibe
2.5. Status de Progress√£o Livre desde o Tratamento com Erdafitinibe
2.6. Ra√ßa
2.7. Classe da Amostra
2.8. Sexo
2.9. Status de Fumador
2.10. Status Som√°tico
2.11. Tipo de MSI (Instabilidade de Microssat√©lites)
2.12. C√≥digo Oncotree

Na an√°lise dessas vari√°veis num√©ricas, come√ßamos por:

1. Gr√°fico de barras para visualizar as frequ√™ncias absolutas:
    - Um gr√°fico de barras √© criado para representar a frequ√™ncia absoluta de cada categoria presente nos dados.
   
2. C√°lculo das frequ√™ncias absolutas e relativas:
    - Primeiro, as frequ√™ncias absolutas das diferentes categorias s√£o calculadas.
    - Em seguida, as frequ√™ncias relativas s√£o obtidas dividindo as frequ√™ncias absolutas pelo total de observa√ß√µes.

3. Cria√ß√£o de um data frame com as frequ√™ncias absolutas e relativas:
    - Um data frame chamado freq_data √© criado, contendo tr√™s colunas:
        - Categoria: Os nomes das diferentes categorias.
        - Frequencia_Absoluta: As frequ√™ncias absolutas correspondentes.
        - Frequencia_Relativa: As frequ√™ncias relativas correspondentes.

4. Gr√°fico de barras para as frequ√™ncias absolutas:
    - Um novo gr√°fico de barras √© gerado para representar as frequ√™ncias absolutas das categorias.

5. Gr√°fico de barras para as frequ√™ncias relativas:
    - Outro gr√°fico de barras √© criado para mostrar a distribui√ß√£o relativa das categorias.
    - O t√≠tulo do gr√°fico √© "Distribui√ß√£o Relativa por Categoria".
    - O eixo x √© rotulado como "Categoria" e o eixo y √© rotulado como "Frequ√™ncia Relativa".

6. Gr√°fico de pizza:
    - Por fim, um gr√°fico de pizza √© gerado para ilustrar a distribui√ß√£o relativa das categorias.
    - Os r√≥tulos das fatias da pizza incluem o nome da categoria e a porcentagem correspondente arredondada.

#### 2.1. Detalhes do Tipo de C√¢ncro
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$CANCER_TYPE_DETAILED), 
        main = "Frequ√™ncia Absoluta por Tipo de Cancro",
        xlab = "Tipo de Cancro", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$CANCER_TYPE_DETAILED)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Tipo de Cancro",
        xlab = "Tipo de Cancro", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Tipo de Cancro",
        xlab = "Tipo de Cancro", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Tipo de Cancro",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)), cex = 0.8)
```
####2.2. Estado da Doen√ßa
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$DISEASE_STATE), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$DISEASE_STATE)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)),
    cex = 0.8)
```
####2.3. Tratamento com Erdafitinibe
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$ERDAFITINIB_TREATED), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$ERDAFITINIB_TREATED)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)),
    cex = 0.8)
```
####2.4. Status de Sobreviv√™ncia Global desde o Tratamento com Erdafitinibe
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$ERDAFITINIB_TX_OS_STATUS), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$ERDAFITINIB_TX_OS_STATUS)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)), cex = 0.8)
```
####2.5. Status de Progress√£o Livre desde o Tratamento com Erdafitinibe
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$ERDAFITINIB_TX_PFS_STATUS), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$ERDAFITINIB_TX_PFS_STATUS)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)), cex = 0.8)
```
####2.6. Ra√ßa
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$RACE), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$RACE)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)),
    cex = 0.8)
```
####2.8. Sexo
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$SEX), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$SEX)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)),
    cex = 0.8)
```
####2.9. Status de Fumador
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(smoking_status), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(smoking_status)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)),
    cex = 0.8)
```
####2.10. Status Som√°tico
```{r}
# Gr√°fico de barras para visualizar as frequ√™ncias absolutas
barplot(table(bladder_clin$SOMATIC_STATUS), 
        main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Calcular as frequ√™ncias absolutas e relativas
freq_abs <- table(bladder_clin$SOMATIC_STATUS)
freq_rel <- prop.table(freq_abs)

# Criar um data frame com as frequ√™ncias absolutas e relativas
freq_data <- data.frame(Categoria = names(freq_abs),
                        Frequencia_Absoluta = as.numeric(freq_abs),
                        Frequencia_Relativa = as.numeric(freq_rel))

# Gr√°fico de barras para as frequ√™ncias absolutas
barplot(freq_abs, main = "Frequ√™ncia Absoluta por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Absoluta")

# Gr√°fico de barras para as frequ√™ncias relativas
barplot(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
        xlab = "Categoria", ylab = "Frequ√™ncia Relativa")

# Criar o gr√°fico de pizza
pie(freq_rel, main = "Distribui√ß√£o Relativa por Categoria",
    labels = paste(names(freq_rel), ": ", round(freq_rel * 100, 2), "%"), 
    col = rainbow(length(freq_rel)),
    cex = 0.8)
```
### 3. Vari√°veis Cont√≠nuas:

3.1. *Melhor Resposta ao Erdafitinib*
3.2. *Fra√ß√£o do Genoma Alterado*
3.3. *Contagem de Muta√ß√µes*
3.4. *TMB*
3.5. *Pureza do Tumor*


Na an√°lise dessas vari√°veis num√©ricas, come√ßamos por:

1. **Resumo estat√≠stico**: Utiliza a fun√ß√£o `summary()` para calcular estat√≠sticas descritivas, como m√≠nimo, 1¬∫ quartil, mediana, m√©dia, 3¬∫ quartil e m√°ximo da vari√°vel dependente. Os valores ausentes s√£o removidos antes do c√°lculo (`na.omit()`).

2. **Desvio padr√£o**: Calcula o desvio padr√£o da vari√°vel dependente usando a fun√ß√£o `sd()`. Novamente, os valores ausentes s√£o removidos antes do c√°lculo.

3. **Intervalo interquart√≠lico (IQR)**: Calcula o intervalo interquart√≠lico da vari√°vel dependente usando a fun√ß√£o `IQR()`. Os valores ausentes s√£o removidos antes do c√°lculo.

4. **Visualiza√ß√£o de frequ√™ncia**: Plota um histograma de frequ√™ncia dos valores da vari√°vel dependente usando a fun√ß√£o `plot(table(...))`.

5. **Gr√°fico de caixa (boxplot)**: Cria um gr√°fico de caixa para visualizar a distribui√ß√£o dos valores da vari√°vel dependente. Os valores ausentes s√£o removidos antes de criar o gr√°fico.


####3.1. Melhor Resposta ao Erdafitinib
```{r}
# Remover valores ausentes e calcular o valor minimo, 1¬∫ quartil, mediana, m√©dia, 3¬∫ quartil e valor m√°ximo da variavel.
summary_best_response <- summary(na.omit(bladder_clin$BEST_RESPONSE))
# Visualizar os valores
summary_best_response

# Remover valores ausentes e calcular o desvio padr√£o da variavel.
sd_best_response <- sd(na.omit(bladder_clin$BEST_RESPONSE))
# Visualizar o valor
sd_best_response

# Remover valores ausentes e calcular o Intervalo interquartilico.
IQR_best_response <- IQR(na.omit(bladder_clin$BEST_RESPONSEb))
# Visualizar o valor
IQR_best_response

plot(table(bladder_clin$BEST_RESPONSE))

boxplot(na.omit(bladder_clin$BEST_RESPONSE),  
        main = "Melhor resposta ao Erdafitinib",   
        xlab = "Melhor Resposta",                 
        horizontal = TRUE)     
                  
```
####3.2. Fra√ß√£o do Genoma Alterado
```{r}
# Remover valores ausentes e calcular o valor minimo, 1¬∫ quartil, mediana, m√©dia, 3¬∫ quartil e valor m√°ximo da variavel.
summary_ <- summary(na.omit(bladder_clin$FRACTION_GENOME_ALTERED))
# Visualizar os valores
summary_

# Remover valores ausentes e calcular o desvio padr√£o da variavel.
sd_ <- sd(na.omit(bladder_clin$FRACTION_GENOME_ALTERED))
# Visualizar o valor
sd_

# Remover valores ausentes e calcular o Intervalo interquartilico.
IQR_ <- IQR(na.omit(bladder_clin$FRACTION_GENOME_ALTERED))
# Visualizar o valor
IQR_

# Calcular a vari√¢ncia
var_ <- var(na.omit(bladder_clin$FRACTION_GENOME_ALTERED))

# Visualizar o valor da vari√¢ncia
var_

# Criar o gr√°fico de caixa
# Filtrar os dados nao numericos
filtered_data <- bladder_clin[complete.cases(bladder_clin$FRACTION_GENOME_ALTERED), ]
boxplot(filtered_data$FRACTION_GENOME_ALTERED, horizontal=T)
```
####3.3. Contagem de Muta√ß√µes
```{r}
# Remover valores ausentes e calcular o valor minimo, 1¬∫ quartil, mediana, m√©dia, 3¬∫ quartil e valor m√°ximo da variavel.
summary_ <- summary(na.omit(bladder_clin$MUTATION_COUNT))
# Visualizar os valores
summary_

# Remover valores ausentes e calcular o desvio padr√£o da variavel.
sd_ <- sd(na.omit(bladder_clin$MUTATION_COUNT))
# Visualizar o valor
sd_

# Remover valores ausentes e calcular o Intervalo interquartilico.
IQR_ <- IQR(na.omit(bladder_clin$MUTATION_COUNT))
# Visualizar o valor
IQR_

# Calcular a vari√¢ncia
var_ <- var(na.omit(bladder_clin$MUTATION_COUNT))

# Visualizar o valor da vari√¢ncia
var_

barplot(table(bladder_clin$MUTATION_COUNT))

# Criar o gr√°fico de caixa
boxplot(bladder_clin$MUTATION_COUNT, horizontal=T)
```
# Rela√ß√£o Tempo de sobreviv√™ncia global e o sexo

##An√°lise de express√£o diferencial e de enriquecimento

Nesta fase, iremos realizar uma an√°lise estat√≠stica univariada, bem como an√°lises de express√£o diferencial e de enriquecimento. 

As vari√°veis a serem consideradas incluem o Tempo de sobreviv√™ncia global (Meses desde o inicio de tratamento com Erdafitinib)(bladder_clin$ERDAFITINIB_TX_OS_MONTHS) e o sexo (bladder_clin$SEX).
```{r}
# Verificar a classe da vari√°vel SEX
print(class(bladder_clin$SEX))

# Visualizar os diferentes valores presentes na vari√°vel SEX ap√≥s a limpeza
unique_values_cleaned <- unique(bladder_clin$SEX)
print(unique_values_cleaned)

# Converter a vari√°vel 'ERDAFITINIB_TX_OS_MONTHS' para num√©rica, se necess√°rio
bladder_clin$ERDAFITINIB_TX_OS_MONTHS <- as.numeric(bladder_clin$ERDAFITINIB_TX_OS_MONTHS)

# Estat√≠sticas sum√°rias de Sobreviv√™ncia Global desde o in√≠cio do tratamento para cada sexo
est_sumarias <- by(bladder_clin$ERDAFITINIB_TX_OS_MONTHS, bladder_clin$SEX, summary)
print(est_sumarias)

# Boxplot da Sobreviv√™ncia Global desde o in√≠cio do tratamento para cada sexo
boxplot(bladder_clin$ERDAFITINIB_TX_OS_MONTHS ~ bladder_clin$SEX, 
        col = c("pink", "blue", "yellow"), 
        main = "Distribui√ß√£o do Tempo de Sobrevida por Sexo",
        xlab = "Sexo",
        ylab = "Tempo de Sobrevida")
```
###Gr√°fico de dispers√£o
```{r}
# Definir um vetor de cores correspondente aos n√≠veis √∫nicos de bladder_clin$SEX
cores <- c("blue", "pink", "yellow")[as.numeric(factor(bladder_clin$SEX))]

# Criar o gr√°fico de dispers√£o com pontos preenchidos seguindo o esquema de cores da legenda
plot(bladder_clin$ERDAFITINIB_TX_OS_MONTHS, 
     main = "Sobreviv√™ncia Global vs Sexo", 
     ylab = "Sobreviv√™ncia Global (Meses)", 
     xlab = "Sexo",
     pch = 19,  # Define o s√≠mbolo dos pontos como preenchidos
     col = cores)  # Define a cor dos pontos conforme o esquema de cores da legenda

# Adicionar a legenda
legend("topright", legend = unique(bladder_clin$SEX), fill = c("blue", "pink", "yellow"))


```

```{r}
```
###ANOVA
Para avaliar se o Tempo de Sobreviv√™ncia Global desde o in√≠cio do tratamento para cada Sexo, foi considerada a avalia√ß√£o da vari√°vel transformada.
Desenhamos o gr√°fico boxplot que permita efetuar a compara√ß√£o da distribui√ß√£o do logaritmo do tempo de Sobreviv√™ncia Global desde o in√≠cio do tratamento.

Testar a hip√≥tese nula ùêª0: ùúámasculino = ùúáfeminino, onde Œº indica o valor m√©dio para cada sexo.
√â sugerida a utiliza√ß√£o de uma ANOVA para a vari√°vel transformada (log(x)). 

Verificar os pressupostos para poder efetuar a dita an√°lise. 
Consideramos Œ±=1% (Utilizamos tamb√©m o teste de Shapiro (normalidade) e o teste de Fligner(homogeneidade)).

```{r}
boxplot(log(bladder_clin$ERDAFITINIB_TX_OS_MONTHS) ~ bladder_clin$SEX, 
        col = c("pink", "blue", "yellow"), 
        main = "Distribui√ß√£o do Logaritmo do Tempo de Sobrevida por Sexo",
        xlab = "Sexo",
        ylab = "Logaritmo do Tempo de Sobrevida")

# Normalidade (conseguimos assegurar que a amostra segue uma distribui√ß√£o normal)
shapiro_test <- shapiro.test(log(bladder_clin$ERDAFITINIB_TX_OS_MONTHS))
print(shapiro_test)

# Homogeneidade (conseguimos assegurar que existe homogeneidade dos dados)
fligner_test <- fligner.test(log(bladder_clin$ERDAFITINIB_TX_OS_MONTHS) ~ bladder_clin$SEX)
print(fligner_test)

# Ap√≥s confirmarmos os pressupostos de normalidade e homogeneidade, realizamos a ANOVA
modelo_log <- aov(log(bladder_clin$ERDAFITINIB_TX_OS_MONTHS) ~ bladder_clin$SEX)
summary(modelo_log)

#Ao realizarmos a Anova percebemos que existe intera√ß√£o entre os grupos Unknown-Female e Unknown-Male.

# Compara√ß√£o m√∫ltipla
TukeyHSD(modelo_log, conf.level = 0.99)
```

Pretendemos avaliar se o Tempo m√©dio de Sobreviv√™ncia Global desde o in√≠cio do tratamento varia para cada Sexo.
Para tal, sugere-se a realiza√ß√£o de uma ANOVA que permita avaliar os efeitos principais e a poss√≠vel intera√ß√£o entre os grupos.
Que pode concluir (use Œ±=5%)
```{r}
modelo_2 <- aov(bladder_clin$ERDAFITINIB_TX_OS_MONTHS ~ bladder_clin$SEX)
summary(modelo_2)
plot(modelo_2)

# Compara√ß√£o m√∫ltipla
TukeyHSD(modelo_2)

# Teste de normalidade nos res√≠duos
shapiro.test(modelo_2$residuals)

# Gr√°ficos de intera√ß√£o (NAO ESTA A FUNCIONAR)
#interaction.plot(bladder_clin$ERDAFITINIB_TX_OS_MONTHS, bladder_clin$SEX, 
 #            modelo_2, type = "b", col = c("pink", "blue", "yellow"), legend = TRUE)
# Certifique-se de que n√£o h√° valores faltantes nas vari√°veis
```
# Rela√ß√£o melhor resposta ao Erdafitinib e o tratamento

####An√°lise de express√£o diferencial e de enriquecimento

As vari√°veis a serem consideradas incluem a Melhor resposta ao Erdafitinib (bladder_clin$BEST_RESPONSE) e o tratamento (bladder_clin$ERDAFITINIB_TREATED).

```{r}
# Estat√≠sticas sum√°rias de Melhor Resposta ao Erdafitinib para os individuos que est√£o a fazer o tratamento e  # para os que n√£o est√£o a fazer.
est_sumarias <- by(bladder_clin$BEST_RESPONSE, bladder_clin$ERDAFITINIB_TREATED, summary)
print(est_sumarias)

# Boxplot da Melhor Resposta ao Erdafitinib para cada grupo

cores <- ifelse(bladder_clin$ERDAFITINIB_TREATED == "Sim", "red", "green")
boxplot(bladder_clin$BEST_RESPONSE ~ bladder_clin$ERDAFITINIB_TREATED, 
        col = cores,
        main = "Boxplot da Melhor Resposta ao Erdafitinib para cada grupo",
        xlab = "Erdafitinib Treated",
        ylab = "Melhor Resposta ao Erdafitinib")
```
###Teste √†s variancias
```{r}
# Teste de igualdade de vari√¢ncia
teste_var <- var.test(bladder_clin$BEST_RESPONSE ~ bladder_clin$ERDAFITINIB_TREATED)
print(teste_var)


 #Ser√° que os dois grupos apresentam a mesma vari√¢ncia?
 #Hip√≥teses:
 #H0: A vari√¢ncia √© a mesma da melhor resposta ao tratamento nos individuos que est√£o a fazer o tratamento e       #para os que n√£o est√£o a fazer.
 #H1: A vari√¢ncia √© diferente na melhor resposta ao tratamento nos individuos que est√£o a fazer o tratamento e  #para os que n√£o est√£o a fazer.
# Decis√£o com Œ±=5%
if (teste_var$p.value > 0.05) {
  cat("N√£o rejeitar H0")
} else {
  cat("Rejeitar H0")}
#Aqui conseguimos concluir que para um p-value de 0,05% exitem evidencia cientifica para afirmar que existem
# diferencas significativas entre as variancias dos dois grupos. 
```


```{r}
# Realizamos o plot do gr√°fico de dispers√£o
plot(bladder_clin$BEST_RESPONSE, 
     main = "Melhor resposta ao tratamento vs Tratamento", 
     ylab = "Melhor resposta ao tratamento", 
     xlab = "Tratamento")
legend("topright", legend = unique(bladder_clin$ERDAFITINIB_TREATED), fill = c("green", "red"))
```
###T-test (teste das m√©dias)
Efetuamos o teste estat√≠stico mais apropriado, neste caso o t-test os valores m√©dios de Melhor Resposta ao Erdafitinib para os individuos que est√£o a fazer o tratamento e para os que n√£o est√£o a fazer.

Hip√≥teses:
H0: N√£o existem diferen√ßas no valor m√©dio da melhor resposta ao tratamento para cada grupo
H1: Existem diferen√ßas no valor m√©dio da melhor resposta ao tratamento para cada grupo

Teste t para comparar os valores m√©dios da melhor resposta ao tratamento para cada grupo
```{r}
teste_t <- t.test(bladder_clin$BEST_RESPONSE ~ bladder_clin$ERDAFITINIB_TREATED, var.equal = TRUE)
print(teste_t)

# Decis√£o com Œ±=5%
if (teste_t$p.value > 0.05) {
  cat("N√£o rejeitar H0 se p-value for  0,05")
} else {
  cat("Rejeitar H0 se p-value for  0,05")}

# Decis√£o com Œ±=1%
if (teste_t$p.value > 0.01) {
  cat("N√£o rejeitar H0 se p-value for  0,01")
} else {
  cat("Rejeitar H0 se p-value for  0,01")}

# Aqui conseguimos concluir que para um p-value de 0,05 e ainda de 0,01 n√£o exitem evidencia cientifica para afirmar # que existem diferencas significativas entre as m√©dias dos dois grupos. 
```


```{r}
